<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hogwarts Run: The Final Battle</title>
    <style>
        :root { --gold: #d4af37; --maroon: #740001; --parchment: #fdf5e6; --dark: #0a0a0a; }
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Georgia', serif; color: white; user-select: none; }
        
        /* UI Screens */
        .screen {
            position: absolute; width: 100%; height: 100%; 
            background: radial-gradient(circle, #2c1e16 0%, #000 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 100; transition: opacity 0.5s;
        }
        .hidden { display: none !important; }

        .menu-btn {
            background: var(--maroon); color: var(--gold);
            border: 3px double var(--gold); padding: 12px 30px;
            margin: 8px; font-size: 20px; cursor: pointer;
            width: 280px; border-radius: 10px; transition: 0.2s;
            font-variant: small-caps; font-weight: bold;
        }
        .menu-btn:hover { background: var(--gold); color: var(--maroon); transform: scale(1.05); }

        /* Panels */
        .panel { 
            background: rgba(0,0,0,0.8); padding: 25px; border: 2px solid var(--gold);
            border-radius: 15px; max-width: 90%; width: 400px;
        }
        .row { display: flex; justify-content: space-between; align-items: center; margin: 15px 0; }
        
        canvas { display: block; filter: contrast(1.1) brightness(1.1); }
        
        /* HUD */
        #hud {
            position: absolute; top: 15px; left: 15px; z-index: 10;
            background: rgba(0,0,0,0.6); padding: 10px; border-radius: 8px;
            border-left: 4px solid var(--gold); font-family: monospace;
        }
        #task-box {
            position: absolute; top: 15px; right: 15px; z-index: 10;
            background: rgba(116, 0, 1, 0.4); padding: 10px; border-radius: 8px;
            text-align: right; border-right: 4px solid var(--gold);
        }
        .key-val { color: var(--gold); font-weight: bold; }
    </style>
</head>
<body>

    <div id="hud" class="hidden">
        Score: <span id="score" class="key-val">0</span><br>
        Potions: <span id="potion-count" class="key-val">0</span><br>
        Keys: <span id="key-count" class="key-val">0</span>
    </div>

    <div id="task-box" class="hidden">
        <b>MISSION</b><br>
        <span id="task-desc">Evade Voldemort</span>
    </div>

    <div id="main-menu" class="screen">
        <h1 style="color:var(--gold); text-shadow: 0 0 20px var(--maroon); font-size: 3.5rem; margin-bottom: 0;">HOGWARTS RUN</h1>
        <p style="color:var(--gold); margin-top: 0; letter-spacing: 2px;">ESCAPE THE DARK LORD</p>
        <button class="menu-btn" onclick="startGame()">⚡ CAST PLAY ⚡</button>
        <button class="menu-btn" onclick="switchScreen('char-screen')">CUSTOMIZE HERO</button>
        <button class="menu-btn" onclick="switchScreen('shop-screen')">DIAGON ALLEY (SHOP)</button>
        <button class="menu-btn" onclick="toggleAudio()">SOUND: <span id="s-status">OFF</span></button>
        <div style="margin-top: 20px; color: var(--gold)">Best Score: <span id="best-score">0</span></div>
    </div>

    <div id="char-screen" class="screen hidden">
        <div class="panel">
            <h2 style="text-align:center; color:var(--gold)">Wizard Identity</h2>
            <div class="row">
                <label>Character</label>
                <select id="char-name" onchange="syncPlayer()">
                    <option value="Harry">Harry</option>
                    <option value="Hermione">Hermione</option>
                    <option value="Ron">Ron</option>
                    <option value="Neville">Neville</option>
                </select>
            </div>
            <div class="row">
                <label>Robe Color</label>
                <input type="color" id="robe-color" value="#740001" onchange="syncPlayer()">
            </div>
            <div class="row">
                <label>Skin Tone</label>
                <input type="color" id="skin-color" value="#ffdbac" onchange="syncPlayer()">
            </div>
            <button class="menu-btn" onclick="switchScreen('main-menu')">SAVE CHANGES</button>
        </div>
    </div>

    <div id="shop-screen" class="screen hidden">
        <div class="panel">
            <h2 style="text-align:center; color:var(--gold)">Diagon Alley Upgrades</h2>
            <div class="row">
                <span>Broom Duration (5 Keys)</span>
                <button onclick="buyUpgrade('broom')" class="menu-btn" style="width:80px; font-size:14px">BUY</button>
            </div>
            <div class="row">
                <span>Score Multiplier (10 Keys)</span>
                <button onclick="buyUpgrade('score')" class="menu-btn" style="width:80px; font-size:14px">BUY</button>
            </div>
            <p style="text-align:center">Available Keys: <span id="shop-keys" class="key-val">0</span></p>
            <button class="menu-btn" onclick="switchScreen('main-menu')">BACK</button>
        </div>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        // --- Persistence & State ---
        let gameData = JSON.parse(localStorage.getItem('hogwartsRunData')) || {
            best: 0, keys: 0, broomLevel: 1, scoreMult: 1,
            char: { name: 'Harry', robe: '#740001', skin: '#ffdbac' }
        };

        let state = 'MENU';
        let lane = 1; 
        let score = 0, potions = 0, currentKeys = 0;
        let jumpY = 0, isJumping = false;
        let broomActive = false, broomTime = 0;
        let obstacles = [], collectibles = [], speed = 6;
        let frame = 0, voldyY = 0;

        // --- Core Functions ---
        function save() { 
            localStorage.setItem('hogwartsRunData', JSON.stringify(gameData)); 
            document.getElementById('best-score').innerText = gameData.best;
            document.getElementById('shop-keys').innerText = gameData.keys;
        }
        save();

        function switchScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            if(id !== 'none') document.getElementById(id).classList.remove('hidden');
        }

        function syncPlayer() {
            gameData.char.name = document.getElementById('char-name').value;
            gameData.char.robe = document.getElementById('robe-color').value;
            gameData.char.skin = document.getElementById('skin-color').value;
            save();
        }

        function buyUpgrade(type) {
            if (type === 'broom' && gameData.keys >= 5) {
                gameData.keys -= 5; gameData.broomLevel++;
            } else if (type === 'score' && gameData.keys >= 10) {
                gameData.keys -= 10; gameData.scoreMult++;
            } else { alert("Not enough keys! Collect mystery boxes."); }
            save();
        }

        // --- Audio Synth (No Copyright) ---
        let audio;
        function toggleAudio() {
            if (!audio) {
                audio = new (window.AudioContext || window.webkitAudioContext)();
                playNotes();
                document.getElementById('s-status').innerText = "ON";
            }
        }
        function playNotes() {
            const freq = [493, 659, 783, 739, 659, 987, 880, 739];
            let t = audio.currentTime;
            freq.forEach(f => {
                let osc = audio.createOscillator();
                let g = audio.createGain();
                osc.frequency.setValueAtTime(f, t);
                g.gain.setValueAtTime(0.1, t);
                g.gain.exponentialRampToValueAtTime(0.0001, t + 0.6);
                osc.connect(g); g.connect(audio.destination);
                osc.start(t); osc.stop(t + 0.6);
                t += 0.6;
            });
            setTimeout(playNotes, 6000);
        }

        // --- Game Engine ---
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize); resize();

        window.addEventListener('keydown', e => {
            if(state !== 'PLAYING') return;
            if(e.key === 'ArrowLeft' && lane > 0) lane--;
            if(e.key === 'ArrowRight' && lane < 2) lane++;
            if(e.key === 'ArrowUp' && !isJumping) startJump();
        });

        window.addEventListener('dblclick', () => {
            if(potions >= 5 && !broomActive) {
                broomActive = true; potions -= 5;
                broomTime = 200 + (gameData.broomLevel * 50);
            }
        });

        function startJump() {
            isJumping = true; let t = 0;
            let j = setInterval(() => {
                jumpY = Math.sin(t) * 120; t += 0.12;
                if(t >= Math.PI) { clearInterval(j); isJumping = false; jumpY = 0; }
            }, 16);
        }

        function startGame() {
            state = 'PLAYING'; switchScreen('none');
            document.getElementById('hud').classList.remove('hidden');
            document.getElementById('task-box').classList.remove('hidden');
            score = 0; potions = 0; currentKeys = 0; speed = 7; obstacles = []; collectibles = [];
            loop();
        }

        function loop() {
            if(state !== 'PLAYING') return;
            ctx.clearRect(0,0,canvas.width, canvas.height);
            frame++; speed += 0.001;
            
            drawWorld();
            handleLogic();
            drawActors();
            
            score += Math.floor(1 * gameData.scoreMult);
            document.getElementById('score').innerText = score;
            document.getElementById('potion-count').innerText = potions;
            document.getElementById('key-count').innerText = currentKeys;
            
            requestAnimationFrame(loop);
        }

        function drawWorld() {
            // Perspective Road
            ctx.fillStyle = '#111';
            ctx.beginPath();
            ctx.moveTo(canvas.width*0.4, 0); ctx.lineTo(canvas.width*0.6, 0);
            ctx.lineTo(canvas.width, canvas.height); ctx.lineTo(0, canvas.height);
            ctx.fill();
            
            // Lane Lines
            ctx.strokeStyle = var(--gold);
            ctx.setLineDash([30, 30]);
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(canvas.width*0.47, 0); ctx.lineTo(canvas.width*0.3, canvas.height);
            ctx.moveTo(canvas.width*0.53, 0); ctx.lineTo(canvas.width*0.7, canvas.height);
            ctx.stroke();
            ctx.setLineDash([]);
        }

        function handleLogic() {
            // Spawn Obstacles (Dementors/Walls)
            if(frame % 80 === 0) obstacles.push({ lane: Math.floor(Math.random()*3), y: 0 });
            // Spawn Potions/Boxes
            if(frame % 50 === 0) collectibles.push({ 
                lane: Math.floor(Math.random()*3), y: 0, 
                type: Math.random() > 0.15 ? 'POTION' : 'MYSTERY' 
            });

            obstacles.forEach((o, i) => {
                o.y += speed;
                let x = (canvas.width/2) + (o.lane - 1) * (o.y * 0.4);
                ctx.fillStyle = '#444'; ctx.fillRect(x - (o.y*0.05), o.y, o.y*0.1, 20); // Wall
                
                // Collision
                if(o.y > canvas.height - 120 && o.y < canvas.height - 40 && o.lane === lane && !broomActive && !isJumping) {
                    gameOver();
                }
            });

            collectibles.forEach((c, i) => {
                c.y += speed;
                let x = (canvas.width/2) + (c.lane - 1) * (c.y * 0.4);
                ctx.fillStyle = c.type === 'POTION' ? '#4f4' : '#f4f';
                ctx.beginPath(); ctx.arc(x, c.y, 5 + (c.y*0.02), 0, 7); ctx.fill();

                if(c.y > canvas.height - 120 && c.y < canvas.height - 40 && c.lane === lane) {
                    if(c.type === 'POTION') potions++; else currentKeys++;
                    collectibles.splice(i, 1);
                }
            });

            if(broomActive) {
                broomTime--;
                if(broomTime <= 0) broomActive = false;
            }
        }

        function drawActors() {
            let px = (canvas.width/2) + (lane - 1) * (canvas.height * 0.35);
            let py = canvas.height - 120 - jumpY;

            // Player
            ctx.fillStyle = gameData.char.robe;
            ctx.fillRect(px - 20, py, 40, 50); // Body
            ctx.fillStyle = gameData.char.skin;
            ctx.beginPath(); ctx.arc(px, py-15, 15, 0, 7); ctx.fill(); // Head
            
            if(broomActive) {
                ctx.strokeStyle = '#8b4513'; ctx.lineWidth = 6;
                ctx.beginPath(); ctx.moveTo(px-50, py+30); ctx.lineTo(px+50, py+30); ctx.stroke();
            }

            // Voldemort chasing behind
            voldyY = 100 + Math.sin(frame*0.05)*20;
            ctx.fillStyle = 'rgba(255,255,255,0.1)';
            ctx.font = "20px Georgia";
            ctx.fillText("VOLDEMORT IS GAINING...", canvas.width/2 - 100, voldyY);
        }

        function gameOver() {
            state = 'OVER';
            gameData.keys += currentKeys;
            if(score > gameData.best) gameData.best = score;
            save();
            switchScreen('main-menu');
            alert(`Stupefied! Score: ${score}. Keys Collected: ${currentKeys}`);
        }

    </script>
</body>
</html>